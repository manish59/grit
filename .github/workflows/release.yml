name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: grit-linux-x86_64
          - target: x86_64-apple-darwin
            os: macos-latest
            name: grit-macos-x86_64
          - target: aarch64-apple-darwin
            os: macos-latest
            name: grit-macos-aarch64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create archive
        shell: bash
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/grit dist/
          cp README.md LICENSE dist/
          cd dist
          tar -czvf ../${{ matrix.name }}.tar.gz *
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}.tar.gz

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      sha256_linux: ${{ steps.sha256.outputs.linux }}
      sha256_macos_x86: ${{ steps.sha256.outputs.macos_x86 }}
      sha256_macos_arm: ${{ steps.sha256.outputs.macos_arm }}
      sha256_source: ${{ steps.sha256.outputs.source }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Calculate SHA256 checksums
        id: sha256
        run: |
          echo "linux=$(sha256sum artifacts/grit-linux-x86_64/grit-linux-x86_64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "macos_x86=$(sha256sum artifacts/grit-macos-x86_64/grit-macos-x86_64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "macos_arm=$(sha256sum artifacts/grit-macos-aarch64/grit-macos-aarch64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          # Calculate source tarball SHA256 (for Homebrew formula)
          curl -sL "https://github.com/manish59/grit/archive/refs/tags/${{ github.ref_name }}.tar.gz" -o source.tar.gz
          echo "source=$(sha256sum source.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Create checksums file
        run: |
          cd artifacts
          echo "# SHA256 Checksums" > ../checksums.txt
          echo "" >> ../checksums.txt
          sha256sum grit-linux-x86_64/grit-linux-x86_64.tar.gz >> ../checksums.txt
          sha256sum grit-macos-x86_64/grit-macos-x86_64.tar.gz >> ../checksums.txt
          sha256sum grit-macos-aarch64/grit-macos-aarch64.tar.gz >> ../checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/grit-linux-x86_64/grit-linux-x86_64.tar.gz
            artifacts/grit-macos-x86_64/grit-macos-x86_64.tar.gz
            artifacts/grit-macos-aarch64/grit-macos-aarch64.tar.gz
            checksums.txt
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}

  update-homebrew:
    name: Update Homebrew Formula
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout homebrew-grit
        uses: actions/checkout@v4
        with:
          repository: manish59/homebrew-grit
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix
          SHA256="${{ needs.release.outputs.sha256_source }}"

          cat > homebrew-tap/Formula/grit.rb << 'EOF'
          class Grit < Formula
            desc "GRIT: Genomic Range Interval Toolkit for genomic interval operations"
            homepage "https://github.com/manish59/grit"
            url "https://github.com/manish59/grit/archive/refs/tags/v${VERSION}.tar.gz"
            sha256 "${SHA256}"
            license "MIT"
            head "https://github.com/manish59/grit.git", branch: "main"

            depends_on "rust" => :build

            def install
              system "cargo", "install", *std_cargo_args
            end

            test do
              assert_match "grit", shell_output("#{bin}/grit --version")
            end
          end
          EOF

          # Replace placeholders with actual values
          sed -i "s/\${VERSION}/$VERSION/g" homebrew-tap/Formula/grit.rb
          sed -i "s/\${SHA256}/$SHA256/g" homebrew-tap/Formula/grit.rb

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/grit.rb
          git commit -m "Update grit to ${{ github.ref_name }}" || exit 0
          git push

  build-conda:
    name: Build Conda Package
    needs: release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.11"
          channels: conda-forge

      - name: Install conda-build
        shell: bash -el {0}
        run: |
          conda install -y conda-build anaconda-client

      - name: Update recipe SHA256
        run: |
          SHA256="${{ needs.release.outputs.sha256_source }}"
          sed -i.bak "s/PLACEHOLDER_SHA256/$SHA256/g" conda-recipe/meta.yaml

      - name: Build Conda package
        shell: bash -el {0}
        run: |
          conda build conda-recipe/ --output-folder conda-output/

      - name: Upload to Anaconda
        shell: bash -el {0}
        env:
          ANACONDA_API_TOKEN: ${{ secrets.ANACONDA_API_TOKEN }}
        run: |
          anaconda upload --force conda-output/**/grit-*.tar.bz2
